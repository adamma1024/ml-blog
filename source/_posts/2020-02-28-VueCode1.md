---
layout: post
title: å‰ç«¯çŸ¥è¯†ä½“ç³»-Vueæºç 
subtitle: ç®€å†™Vueä»£ç  -- æ•°æ®å“åº”å¼
author: "malin"
header-bg-css: "linear-gradient(to right, #5cadff, #09EF46);"
categories:
  - å‰ç«¯
tags:
  - å‰ç«¯çŸ¥è¯†ä½“ç³»
---

# ç®€å†™Vueä»£ç  -- æ•°æ®å“åº”å¼

> æœ¬ç« è®°å½•ç®€ç‰ˆVue æ•°æ®å“åº”å¼ä»£ç ï¼Œæ³¨é‡Šä¼šæ ‡æ³¨ä½œç”¨ã€‚å¦‚ç¼ºå°‘é‡è¦çŸ¥è¯†ç‚¹ï¼ŒğŸ‘‰ğŸ»[æ¬¢è¿äº¤æµ](https://github.com/qq240814476/ml-blog/issues)

```js
// ç®€ç‰ˆ Vue æ•°æ®ç›‘å¬ä»£ç 
class MVue{
  constructor(options){
    this.$options = options
    this.$data = options.data
    // observe è°ƒç”¨å¤§åé¼é¼çš„ defineReative é‡å†™ get set ç›‘å¬æ•°æ®
    this.observe(this.$data)

    // æ•°æ®ç›‘å¬å®Œå°±å¼€å§‹ç¼–è¯‘äº†
    new Compile(options.el, this)

    // éƒ½å¹²å®Œäº†è°ƒç”¨ç”Ÿå‘½å‘¨æœŸé’©å­
    if(options.create){
      options.create.call(this)
    }
  }

  observe(data){
    if(!data || typeof data !== 'object') return
    Object.keys(data).forEach(key => {
      this.defineReactive(data, key, data[key])

      // ä½¿ç”¨ this.$data.XXX ä¸å¤Ÿä¼˜é›…ï¼Œä»£ç†ä¸‹ ä½¿ç”¨this.XXX è¯·æ±‚
      this.proxyData(key)
    })
  }

  defineReactive(data,key, value){
    // é€’å½’è°ƒç”¨ï¼Œéå†æ‰€æœ‰å±æ€§
    this.observe(value)

    //! æ¯ä¸ªå±æ€§ 1:1 å¯¹åº”ä¸€ä¸ª Dep
    var dep = new Dep()
    Object.defineProperty(data, key, {
      get() {
        //! ä¾èµ–æ”¶é›† Dep.target å®é™…ä¸Šå°±æ˜¯watcher, è§ Watcher ç±»
        Dep.target && dep.addDep(Dep.target)
        return value
      },
      set(val) {
        console.log('ä¿®æ”¹äº†',key,'è®¾ç½®æˆ', val)
        value = val

        //! é€šçŸ¥watcheræ›´æ–°
        dep.notify()
      }
    })
  }

  // this.$data.XXX => this.XXX
  proxyData(key){
    Object.defineProperty(this,key, {
      get(){
        return this.$data[key]
      },
      set(val){
        if(val === this.$data[key]) return
        this.$data[key] = val
      }
    })
  }
}

// å‘å¸ƒ -- è®¢é˜… æ ¸å¿ƒç±»
// æ”¶é›†ä¸€æ³¢ watcher ç›¸å½“äºè®¢é˜… æ•°æ®å˜åŠ¨æ—¶ Dep é€šçŸ¥è®¢é˜…çš„watcher ç›¸å½“äºå‘å¸ƒ
class Dep{
  constructor(){
    this.deps = []
  }

  addDep(watcher){
    this.deps.push(watcher)
  }

  notify(){
    this.deps.forEach(watcher => {
      watcher.update()
    })
  }
}

// ä¸vmç»‘å®šå®ç°updateï¼Œå®é™…åŸç†æ²¡è¿™ä¹ˆç®€å•ï¼Œè¿™åªæ˜¯ç®€åŒ–ç‰ˆ
// çœŸå®çš„æ˜¯ç›´æ¥é‡è°ƒ æ•´ä¸ª update ç„¶åpatch åˆ©ç”¨diffç®—æ³• æ›¿æ¢æ”¹å˜çš„vdom
class Watcher{
  constructor(vm, key, updater){
    this.vm = vm
    this.key = key
    this.updater = updater

    Dep.target = this
    this.vm[key]
    Dep.target = null
  }

  update(){
    this.updater.call(this.vm, this.vm[this.key])
  }
}
```
