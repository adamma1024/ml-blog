---
layout: post
title: Vue æ•°æ®åŠ«æŒè¯¦è§£ -- è§‚å¯Ÿè€…æ¨¡å¼
subtitle: How to listen data change in Vue ğŸ¨
author: "malin"
header-style: text
categories:
  - å‰ç«¯
tags:
  - Vue
---

![image](https://raw.githubusercontent.com/xuqiang521/fe-daily-record/master/javascript/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Observer.png)

> ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ`vue` æ˜¯åˆ©ç”¨çš„æ˜¯ `Object.defineProperty()` å¯¹æ•°æ®è¿›è¡ŒåŠ«æŒã€‚ å¹¶åœ¨æ•°æ®ä¼ é€’å˜æ›´çš„æ—¶å€™å°è£…äº†ä¸€å±‚ä¸­è½¬ç«™ï¼Œå³æˆ‘ä»¬çœ‹åˆ°çš„ `Dep` å’Œ `Watcher` ä¸¤ä¸ªç±»ã€‚

# æ•°æ®åŠ«æŒ

## é€’å½’éå†

`vue` å¯¹äº `data` é‡Œé¢çš„æ•°æ®éƒ½åšäº†åŠ«æŒçš„ï¼Œé‚£åªèƒ½å¯¹å¯¹è±¡è¿›è¡Œéå†ä»è€Œå®Œæˆæ¯ä¸ªå±æ€§çš„åŠ«æŒï¼Œæºç å…·ä½“å¦‚ä¸‹  

```javascript
walk (obj: Object) {
  const keys = Object.keys(obj)
  // éå†å°†å…¶å˜æˆ vue çš„è®¿é—®å™¨å±æ€§
  for (let i = 0; i < keys.length; i++) {
    defineReactive(obj, keys[i], obj[keys[i]])
  }
}
```

<!--more-->

## å‘å¸ƒ/è®¢é˜…
ä»ä¸Šé¢å¯¹è±¡çš„éå†æˆ‘ä»¬çœ‹åˆ°äº† `defineReactive` ï¼Œé‚£ä¹ˆåŠ«æŒæœ€å…³é”®çš„ç‚¹ä¹Ÿåœ¨äºè¿™ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°é‡Œé¢å°è£…äº† `getter` å’Œ `setter` å‡½æ•°ï¼Œä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼Œäº’ç›¸ç›‘å¬
```javascript
// è®¾ç½®ä¸ºè®¿é—®å™¨å±æ€§ï¼Œå¹¶åœ¨å…¶ getter å’Œ setter å‡½æ•°ä¸­ï¼Œä½¿ç”¨å‘å¸ƒ/è®¢é˜…æ¨¡å¼ï¼Œäº’ç›¸ç›‘å¬ã€‚
export function defineReactive (
  obj: Object,
  key: string,
  val: any
) {
  // è¿™é‡Œç”¨åˆ°äº†è§‚å¯Ÿè€…ï¼ˆå‘å¸ƒ/è®¢é˜…ï¼‰æ¨¡å¼è¿›è¡Œäº†åŠ«æŒå°è£…ï¼Œå®ƒå®šä¹‰äº†ä¸€ç§ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…ç›‘å¬ä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œè¿™ä¸ªä¸»é¢˜å¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ä¼šé€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡ï¼Œè§‚å¯Ÿè€…å¯¹è±¡å°±å¯ä»¥æ›´æ–°è‡ªå·±çš„çŠ¶æ€ã€‚
  // å®ä¾‹åŒ–ä¸€ä¸ªä¸»é¢˜å¯¹è±¡ï¼Œå¯¹è±¡ä¸­æœ‰ç©ºçš„è§‚å¯Ÿè€…åˆ—è¡¨
  const dep = new Dep()

  // è·å–å±æ€§æè¿°ç¬¦å¯¹è±¡(æ›´å¤šçš„ä¸ºäº† computed é‡Œé¢çš„è‡ªå®šä¹‰ get å’Œ set è¿›è¡Œçš„è®¾è®¡)
  const property = Object.getOwnPropertyDescriptor(obj, key)
  if (property && property.configurable === false) {
    return
  }

  const getter = property && property.get
  const setter = property && property.set

  let childOb = observe(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    // æ”¶é›†ä¾èµ–ï¼Œå»ºç«‹ä¸€å¯¹å¤šçš„çš„å…³ç³»ï¼Œè®©å¤šä¸ªè§‚å¯Ÿè€…ç›‘å¬å½“å‰ä¸»é¢˜å¯¹è±¡
    get: function reactiveGetter () {
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        dep.depend()
        if (childOb) {
          childOb.dep.depend()
          // è¿™é‡Œæ˜¯å¯¹æ•°ç»„è¿›è¡ŒåŠ«æŒ
          if (Array.isArray(value)) {
            dependArray(value)
          }
        }
      }
      return value
    },
    // åŠ«æŒåˆ°æ•°æ®å˜æ›´ï¼Œå¹¶å‘å¸ƒæ¶ˆæ¯è¿›è¡Œé€šçŸ¥
    set: function reactiveSetter (newVal) {
      const value = getter ? getter.call(obj) : val
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      if (setter) {
        setter.call(obj, newVal)
      } else {
        val = newVal
      }
      childOb = observe(newVal)
      dep.notify()
    }
  })
}
```
## è¿”å› Observer å®ä¾‹

```javascript
return new Observer(value)
```

# æ¶ˆæ¯å°è£…ï¼Œå®ç° â€œä¸­è½¬ç«™â€
æ”¶é›†å®Œè®¢é˜…è€…ä»¬çš„å¯†æ¢ A åªç®¡å‘å¸ƒæ¶ˆæ¯ï¼Œå…±äº§å…š B ä»¥åŠæ›´å¤šçš„å…±äº§å…šåªç®¡è®¢é˜…æ¶ˆæ¯å¹¶è¿›è¡Œå¯¹åº”çš„ `update` æ“ä½œï¼Œæ¯ä¸ªæ¨¡å—ç¡®ä¿å…¶ç‹¬ç«‹æ€§ï¼Œå®ç°`é«˜å†…èšä½è€¦åˆ`è¿™ä¸¤å¤§åŸåˆ™ã€‚  

æ¥ä¸‹æ¥ç›´æ¥å¼€å§‹è®² `vue` æ˜¯å¦‚ä½•åšçš„æ¶ˆæ¯å°è£…çš„  

## Dep

`Dep`ï¼Œå…¨å Dependencyï¼Œä»åå­—æˆ‘ä»¬ä¹Ÿèƒ½å¤§æ¦‚çœ‹å‡º `Dep` ç±»æ˜¯ç”¨æ¥åšä¾èµ–æ”¶é›†çš„ï¼Œå…·ä½“æ€ä¹ˆæ”¶é›†å‘¢ã€‚æˆ‘ä»¬ç›´æ¥çœ‹æºç   
```javascript
let uid = 0

export default class Dep {
  static target: ?Watcher;
  id: number;
  subs: Array<Watcher>;

  constructor () {
    // ç”¨æ¥ç»™æ¯ä¸ªè®¢é˜…è€… Watcher åšå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œé˜²æ­¢é‡å¤æ”¶é›†
    this.id = uid++
    // å®šä¹‰subsæ•°ç»„ï¼Œç”¨æ¥åšä¾èµ–æ”¶é›†(æ”¶é›†æ‰€æœ‰çš„è®¢é˜…è€… Watcher)
    this.subs = []
  }

  // æ”¶é›†è®¢é˜…è€…
  addSub (sub: Watcher) {
    this.subs.push(sub)
  }

  depend () {
    if (Dep.target) {
      Dep.target.addDep(this)
    }
  }

  notify () {
    // stabilize the subscriber list first
    const subs = this.subs.slice()
    for (let i = 0, l = subs.length; i < l; i++) {
      subs[i].update()
    }
  }
}

// the current target watcher being evaluated.
// this is globally unique because there could be only one
// watcher being evaluated at any time.
Dep.target = null
```
>1.  å®šä¹‰subsæ•°ç»„ï¼Œç”¨æ¥æ”¶é›†è®¢é˜…è€…Watcher
>2.  å½“åŠ«æŒåˆ°æ•°æ®å˜æ›´çš„æ—¶å€™ï¼Œé€šçŸ¥è®¢é˜…è€…Watcherè¿›è¡Œupdateæ“ä½œ

æºç ä¸­ï¼Œè¿˜æŠ›å‡ºäº†ä¸¤ä¸ªæ–¹æ³•ç”¨æ¥æ“ä½œ `Dep.target` ï¼Œå…·ä½“å¦‚ä¸‹
```javascript
// å®šä¹‰æ”¶é›†ç›®æ ‡æ ˆ
const targetStack = []

export function pushTarget (_target: Watcher) {
  if (Dep.target) targetStack.push(Dep.target)
  // æ”¹å˜ç›®æ ‡æŒ‡å‘
  Dep.target = _target
}

export function popTarget () {
  // åˆ é™¤å½“å‰ç›®æ ‡ï¼Œé‡ç®—æŒ‡å‘
  Dep.target = targetStack.pop()
}
```
## watcher
`Watcher` æ„ä¸ºè§‚å¯Ÿè€…ï¼Œå®ƒè´Ÿè´£åšçš„äº‹æƒ…å°±æ˜¯è®¢é˜… `Dep` ï¼Œå½“`Dep` å‘å‡ºæ¶ˆæ¯ä¼ é€’ï¼ˆnotifyï¼‰çš„æ—¶å€™ï¼Œæ‰€ä»¥è®¢é˜…ç€ `Dep` çš„ `Watchers` ä¼šè¿›è¡Œè‡ªå·±çš„ `update` æ“ä½œã€‚
```javascript
export default class Watcher {
  vm: Component;
  expression: string;
  cb: Function;

  constructor (
    vm: Component,
    expOrFn: string | Function,
    cb: Function,
    options?: Object
  ) {
    this.vm = vm
    vm._watchers.push(this)
    this.cb = cb
    // parse expression for getter
    if (typeof expOrFn === 'function') {
      this.getter = expOrFn
    } else {
      // è§£æè¡¨è¾¾å¼
      this.getter = parsePath(expOrFn)
      if (!this.getter) {
        this.getter = function () {}
      }
    }
    this.value = this.get()
  }

  get () {
    // å°†ç›®æ ‡æ”¶é›†åˆ°ç›®æ ‡æ ˆ
    pushTarget(this)
    const vm = this.vm

    let value = this.getter.call(vm, vm)
    // åˆ é™¤ç›®æ ‡
    popTarget()

    return value
  }

  // è®¢é˜… Depï¼ŒåŒæ—¶è®© Dep çŸ¥é“è‡ªå·±è®¢é˜…ç€å®ƒ
  addDep (dep: Dep) {
    const id = dep.id
    if (!this.newDepIds.has(id)) {
      this.newDepIds.add(id)
      this.newDeps.push(dep)
      if (!this.depIds.has(id)) {
        // æ”¶é›†è®¢é˜…è€…
        dep.addSub(this)
      }
    }
  }

  // è®¢é˜…è€…'æ¶ˆè´¹'åŠ¨ä½œï¼Œå½“æ¥æ”¶åˆ°å˜æ›´æ—¶åˆ™ä¼šæ‰§è¡Œ
  update () {
    this.run()
  }

  run () {
    const value = this.get()
    const oldValue = this.value
    this.value = value
    this.cb.call(this.vm, value, oldValue)
  }
}
```
ç°åœ¨å†å»çœ‹ Dep å’Œ Watcherï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ä¸¤ä¸ªç‚¹

>1. Dep è´Ÿè´£æ”¶é›†æ‰€æœ‰çš„è®¢é˜…è€… Watcher ï¼Œå…·ä½“è°ä¸ç”¨ç®¡ï¼Œå…·ä½“æœ‰å¤šå°‘ä¹Ÿä¸ç”¨ç®¡ï¼Œåªéœ€è¦é€šè¿‡ target æŒ‡å‘çš„è®¡ç®—å»æ”¶é›†è®¢é˜…å…¶æ¶ˆæ¯çš„ Watcher å³å¯ï¼Œç„¶ååªéœ€è¦åšå¥½æ¶ˆæ¯å‘å¸ƒ notify å³å¯ã€‚
>2. Watcher è´Ÿè´£è®¢é˜… Dep ï¼Œå¹¶åœ¨è®¢é˜…çš„æ—¶å€™è®© Dep è¿›è¡Œæ”¶é›†ï¼Œæ¥æ”¶åˆ° Dep å‘å¸ƒçš„æ¶ˆæ¯æ—¶ï¼Œåšå¥½å…¶ update æ“ä½œå³å¯ã€‚

ä¸¤è€…çœ‹ä¼¼ç›¸äº’ä¾èµ–ï¼Œå®åˆ™å´ä¿è¯äº†å…¶ç‹¬ç«‹æ€§ï¼Œä¿è¯äº†æ¨¡å—çš„å•ä¸€æ€§ã€‚

## VUE eventä¼ é€’ä¹Ÿå±äºè§‚å¯Ÿè€…æ¨¡å¼

## æ€»ç»“

- `Observe` ç±» åˆ¤æ–­æ˜¯å¦æ˜¯æ•°ç»„ï¼Œæ•°ç»„`observeArray`åŠ«æŒç¬¬ä¸€çº§å±æ€§ï¼Œå¯¹è±¡è°ƒç”¨ `walker` éå†keyï¼Œè°ƒç”¨`defineReactive`åŠ«æŒ  
- `defineReactive` åˆ›å»º `Dep` å®ä¾‹ï¼Œåˆ©ç”¨`Object.defineProperty(obj,key,{props})` ä¿®æ”¹getï¼Œset  
- `Dep` æœ‰è‡ªå·±çš„ `id` ï¼Œæœ‰ä¸ªæ•°ç»„ `sub` åšä¾èµ–æ”¶é›† `watcher`
- `watcher` é€šè¿‡ `addDep` æ–¹æ³•æ·»åŠ  `Dep`ï¼Œå¹¶è°ƒç”¨ `addSub` å°†`watcher`æ·»åŠ åˆ°`sub`æ•°ç»„ä¸­
- `obj.set` æ—¶ è°ƒç”¨ `Dep.notify()` éå† `Dep sub` æ•°ç»„ `sub[i]ï¼ˆwatcherï¼‰.update`


