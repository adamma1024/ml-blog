---
layout: post
title: å‰ç«¯çŸ¥è¯†ä½“ç³»-Vueæºç 
subtitle: ç®€å†™Vue -- Compile
author: "malin"
header-bg-css: "linear-gradient(to right, #5cadff, #09EF46);"
categories:
  - å‰ç«¯
tags:
  - å‰ç«¯çŸ¥è¯†ä½“ç³»
---

# ç®€å†™Vue -- Compile

> æœ¬ç« è®°å½•ç®€ç‰ˆVue Complie ç¼–è¯‘åŸç†ä»£ç ï¼Œæ³¨é‡Šä¼šæ ‡æ³¨ä½œç”¨ã€‚å¦‚ç¼ºå°‘é‡è¦çŸ¥è¯†ç‚¹ï¼ŒğŸ‘‰ğŸ»[æ¬¢è¿äº¤æµ](https://github.com/qq240814476/ml-blog/issues)

<!--more-->
```js
// Vue ç®€åŒ– complie
class Compile{
  constructor(el, vm){
    // å–å¾—çœŸå®domå…ƒç´  å¼•ç”¨ç»‘å®šåœ¨ $el ä¸Š
    this.$el = document.querySelector(el)
    this.$vm = vm

    if(this.$el){
      this.compile(this.$el)
    }
  }

  /**
    * éå†æ‰€æœ‰èŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ï¼šæ–‡æœ¬èŠ‚ç‚¹å’Œå…ƒç´ èŠ‚ç‚¹
    */
  compile(el){
    const childs = el.childNodes
    Array.from(childs).forEach(node => {
      if(this.isElement(node)){
        // è§£æv- å’Œ@ æ ‡è®°
        this.compileElement(node)
      } else if(this.isInter(node)){
        // è§£æ {{}}
        this.compileText(node)
      }

      // é€’å½’éå†
      if(node.childNodes && node.childNodes.length > 0){
        // ç¼–è¯‘è¯¥èŠ‚ç‚¹
        this.compile(node)
      }
    })
  }

  isElement(node){
    // nodeType åˆ¤æ–­æ˜¯ä¸æ˜¯element
    return node.nodeType === 1
  }

  isInter(node){
    // æ­£åˆ™ åˆ¤æ–­ åŒ…å«  {{}}
    return node.nodeType === 3 && /\{\{(.*)\}\}/.test(node.textContent)
  }

  compileText(node){
    // æ­£åˆ™å–åˆ° {{XXX}} ä¸­çš„ XXX
    const exp= RegExp.$1

    // åˆå§‹åŒ–æ›´æ–°
    this.update(node, exp, 'text')
  }

  update(node, exp, dir){
    // åˆå§‹åŒ–èµ‹å€¼
    const updateFn = this[dir + 'Updater']
    updateFn && updateFn(node, this.$vm[exp])

    // ä¸ºæ¯ä¸ªkeyè®¾ç½®watcher
    new Watcher(this.$vm, exp, function(value){
      updateFn && updateFn(node,value)
    })
  }

  textUpdater(node, value){
    node.textContent = value
  }

  compileElement(node){
    const attrs = node.attributes
    // å¯»æ‰¾è‡ªå®šä¹‰å‘½ä»¤ v-text = 'mltest'
    Array.from(attrs).forEach(attr => {
      if(attr.name.indexOf('v-') !== -1){
        const dir = attr.name.slice(2)
        const exp = attr.value
        this[dir] && this[dir](node, exp)
      }
    })
  }

  // v-text å‘½ä»¤è§£æ
  text(node, exp){
    this.update(node, exp, 'text')
  }
}
```