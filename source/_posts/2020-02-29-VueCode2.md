---
layout: post
title: ÂâçÁ´ØÁü•ËØÜ‰ΩìÁ≥ª-VueÊ∫êÁ†Å
subtitle: ÁÆÄÂÜôVue -- Compile
author: "malin"
header-bg-css: "linear-gradient(to right, #5cadff, #09EF46);"
categories:
  - ÂâçÁ´Ø
tags:
  - ÂâçÁ´ØÁü•ËØÜ‰ΩìÁ≥ª
---

# ÁÆÄÂÜôVue -- Compile

> Êú¨Á´†ËÆ∞ÂΩïÁÆÄÁâàVue Complie ÁºñËØëÂéüÁêÜ‰ª£Á†ÅÔºåÊ≥®Èáä‰ºöÊ†áÊ≥®‰ΩúÁî®„ÄÇÂ¶ÇÁº∫Â∞ëÈáçË¶ÅÁü•ËØÜÁÇπÔºåüëâüèª[Ê¨¢Ëøé‰∫§ÊµÅ](https://github.com/qq240814476/ml-blog/issues)

```js
// Vue ÁÆÄÂåñ complie
class Compile{
  constructor(el, vm){
    // ÂèñÂæóÁúüÂÆûdomÂÖÉÁ¥† ÂºïÁî®ÁªëÂÆöÂú® $el ‰∏ä
    this.$el = document.querySelector(el)
    this.$vm = vm

    if(this.$el){
      this.compile(this.$el)
    }
  }

  /**
    * ÈÅçÂéÜÊâÄÊúâËäÇÁÇπÔºåÂåÖÊã¨ÔºöÊñáÊú¨ËäÇÁÇπÂíåÂÖÉÁ¥†ËäÇÁÇπ
    */
  compile(el){
    const childs = el.childNodes
    Array.from(childs).forEach(node => {
      if(this.isElement(node)){
        // Ëß£Êûêv- Âíå@ Ê†áËÆ∞
        this.compileElement(node)
      } else if(this.isInter(node)){
        // Ëß£Êûê {{}}
        this.compileText(node)
      }

      // ÈÄíÂΩíÈÅçÂéÜ
      if(node.childNodes && node.childNodes.length > 0){
        // ÁºñËØëËØ•ËäÇÁÇπ
        this.compile(node)
      }
    })
  }

  isElement(node){
    // nodeType Âà§Êñ≠ÊòØ‰∏çÊòØelement
    return node.nodeType === 1
  }

  isInter(node){
    // Ê≠£Âàô Âà§Êñ≠ ÂåÖÂê´  {{}}
    return node.nodeType === 3 && /\{\{(.*)\}\}/.test(node.textContent)
  }

  compileText(node){
    // Ê≠£ÂàôÂèñÂà∞ {{XXX}} ‰∏≠ÁöÑ XXX
    const exp= RegExp.$1

    // ÂàùÂßãÂåñÊõ¥Êñ∞
    this.update(node, exp, 'text')
  }

  update(node, exp, dir){
    // ÂàùÂßãÂåñËµãÂÄº
    const updateFn = this[dir + 'Updater']
    updateFn && updateFn(node, this.$vm[exp])

    // ‰∏∫ÊØè‰∏™keyËÆæÁΩÆwatcher
    new Watcher(this.$vm, exp, function(value){
      updateFn && updateFn(node,value)
    })
  }

  textUpdater(node, value){
    node.textContent = value
  }

  compileElement(node){
    const attrs = node.attributes
    // ÂØªÊâæËá™ÂÆö‰πâÂëΩ‰ª§ v-text = 'mltest'
    Array.from(attrs).forEach(attr => {
      if(attr.name.indexOf('v-') !== -1){
        const dir = attr.name.slice(2)
        const exp = attr.value
        this[dir] && this[dir](node, exp)
      }
    })
  }

  // v-text ÂëΩ‰ª§Ëß£Êûê
  text(node, exp){
    this.update(node, exp, 'text')
  }
}
```