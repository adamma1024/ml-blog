---
layout: post
title: How V8 run？ 
subtitle: 是时候看看v8了
author: "malin"
header-bg-css: "linear-gradient(to right, #5cadff, #09EF46);"
categories:
  - js
tags:
  - js
---

v8如何执行js代码的呢？主要分为：

- 编译
- 执行

机器只认识机器语言，js这种高级语言需要先转成汇编语言再经过汇编语言编译器转成机器语言就是0101才能执行。
v8可以理解成一个虚拟机，虚拟机通过模拟计算机的各种功能：CPU、寄存器、堆栈等，虚拟机还具有自己的一套指令系统。
所以对于js编写者来说，不必担心自己写的代码在不同的计算机中运行结果不一致（cpu类型不同指令集不同），v8都可以转成统一标准的代码。
v8是虚拟机用来编译和执行js代码。

### 机器语言

CPU只认识100010101这种二进制的机器语言。但是这种二进制代码太难记了，不好写。于是就有了汇编语言。汇编语言长得人能看懂了，但是CPU不认识他，于是就需要汇编编译器
来将汇编语言翻译成二进制的机器语言。并且不同的CPU指令集不同，用汇编语言来编写代码需要做大量的适配，并且代码长度很长。所以有了py3，java，js，c，go等高级语言

### 高级语言

CPU也不认识高级语言，这时候有两种方法解决：

1. 解释执行，输入代码-解析器解析-中间代码-解释器解释-输出结果
2. 编译执行，输入代码-解析器解析-中间代码-编译器编译-机器代码-执行-输出结果

不同高级语言都有自己的虚拟机去做这些事情，v8就是js的引擎。苹果是javascriptCore

V8采用的是混合执行，解释执行 + 编译执行

## V8工作顺序

### 准备工作

- 内存初始化堆栈结构，存放变量
- 全局作用域，全局变量
- 全局执行上下文，内置函数，全局变量
- 消息循环系统，包括消息驱动器和消息队列，eventloop，如同v8的心脏不断接受消息和决策如何处理

### 编译，执行 

采用JIT技术，解释 + 优化编译

- 结构化代码，生成ast语法树
- 生成ast同时生成作用域
- 解析器解析出中间代码
- 解释器解释
- 输出结果
- 高频代码会被`监控解释器`记住，走`优化编译器`
- 编译成机器代码
- 执行
- 产出结果
- 代码改动会进行`反优化操作`重走解释器